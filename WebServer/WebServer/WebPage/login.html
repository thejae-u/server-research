<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Server Stress Tester</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .log-area { 
            background-color: #212529; 
            color: #00ff00; 
            font-family: monospace; 
            padding: 10px; 
            height: 300px; 
            overflow-y: auto; 
            font-size: 0.9em;
        }
        .status-badge { font-size: 0.9em; margin-right: 5px; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <header class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
            <h1>üõ†Ô∏è Game Server Stress Tester</h1>
            <div>
                <span id="auth-status" class="badge bg-secondary me-2">Not Logged In</span>
                <button id="logout-btn" class="btn btn-sm btn-outline-danger" style="display:none;">Logout</button>
            </div>
        </header>

        <!-- Authentication Section -->
        <div class="row" id="auth-section">
            <div class="col-md-6 offset-md-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">Login / Setup</div>
                    <div class="card-body">
                        <form id="login-form">
                            <div class="mb-3">
                                <label class="form-label">Username</label>
                                <input type="text" class="form-control" id="username" value="Admin">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-control" id="password" value="testadminpassword">
                            </div>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">Login (Admin/Internal)</button>
                                <button type="button" id="quick-register-btn" class="btn btn-outline-secondary">Quick Register & Login (Random User)</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stress Test Dashboard (Hidden by default) -->
        <div id="dashboard-section" style="display:none;">
            <!-- Server Monitor Section -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <span class="h5 m-0">üìä Server Monitor (Admin Only)</span>
                            <div class="form-check form-switch text-white">
                                <input class="form-check-input" type="checkbox" id="auto-refresh-toggle" checked onchange="toggleMonitor(this.checked)">
                                <label class="form-check-label" for="auto-refresh-toggle">Auto Refresh (3s)</label>
                            </div>
                        </div>
                        <div class="card-body d-flex justify-content-around text-center">
                            <div>
                                <h6 class="text-muted">Total Users</h6>
                                <h2 id="monitor-user-count" class="text-primary">-</h2>
                            </div>
                            <div>
                                <h6 class="text-muted">Active Groups</h6>
                                <h2 id="monitor-group-count" class="text-success">-</h2>
                            </div>
                            <div>
                                <h6 class="text-muted">Last Updated</h6>
                                <p id="monitor-last-update" class="mb-0 text-secondary">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Test Configuration -->
                <div class="col-md-4">
                    <!-- Login Stress -->
                    <div class="card">
                        <div class="card-header bg-warning text-dark">üí• Login/Register Stress</div>
                        <div class="card-body">
                            <div class="mb-2">
                                <label class="form-label">Base Username</label>
                                <input type="text" class="form-control form-control-sm" id="stress-user-base" value="stress_test">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Count</label>
                                <input type="number" class="form-control form-control-sm" id="stress-user-count" value="50">
                            </div>
                            <button class="btn btn-warning w-100 mb-2" onclick="runLoginStress()">Run Login Attack</button>
                            <button class="btn btn-danger w-100" id="flush-players-btn">Flush All Players</button>
                        </div>
                    </div>

                    <!-- Lobby/Inquiry Stress -->
                    <div class="card">
                        <div class="card-header bg-info text-white">üîç Lobby Inquiry Stress</div>
                        <div class="card-body">
                            <div class="mb-2">
                                <label class="form-label">Requests Count</label>
                                <input type="number" class="form-control form-control-sm" id="stress-lobby-count" value="100">
                            </div>
                            <button class="btn btn-info text-white w-100" onclick="runLobbyStress()">Run Lobby Inquiry</button>
                        </div>
                    </div>

                    <!-- Group Create Stress -->
                    <div class="card">
                        <div class="card-header bg-success text-white">üè† Group Creation Stress</div>
                        <div class="card-body">
                            <div class="mb-2">
                                <label class="form-label">Group Name Prefix</label>
                                <input type="text" class="form-control form-control-sm" id="stress-group-prefix" value="StressGroup">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Count</label>
                                <input type="number" class="form-control form-control-sm" id="stress-group-count" value="50">
                            </div>
                            <button class="btn btn-success w-100 mb-2" onclick="runGroupStress()">Run Group Creation</button>
                            <!-- New button for flushing groups -->
                            <button class="btn btn-danger w-100" id="flush-groups-btn">Flush All Groups Cache</button>
                        </div>
                    </div>
                </div>

                <!-- Logs & Results -->
                <div class="col-md-8">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>üìú Request Logs</span>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()">Clear</button>
                        </div>
                        <div class="card-body p-0">
                            <div id="logs" class="log-area">Wait for command...</div>
                        </div>
                        <div class="card-footer text-muted" id="status-footer">
                            Ready
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:18080/api';
        let authToken = null;
        let currentUserInfo = null;
        let monitorInterval = null;

        // --- Auth Logic ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            await performLogin(username, password, true);
        });

        document.getElementById('quick-register-btn').addEventListener('click', async () => {
            const randomId = Math.random().toString(36).substring(7);
            const username = `tester_${randomId}`;
            const password = 'password1234!';
            
            log(`Registering new user: ${username}...`);
            try {
                const res = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, password })
                });

                if(res.ok) {
                    log(`‚úÖ Registration successful for ${username}`);
                    await performLogin(username, password);
                } else {
                    log(`‚ùå Registration failed: ${res.status}`);
                }
            } catch(e) {
                log(`‚ùå Error: ${e.message}`);
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            authToken = null;
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('dashboard-section').style.display = 'none';
            document.getElementById('auth-status').textContent = 'Not Logged In';
            document.getElementById('auth-status').className = 'badge bg-secondary me-2';
            document.getElementById('logout-btn').style.display = 'none';
            stopMonitor(); // Stop monitoring on logout
            log("Logged out.");
        });

        async function performLogin(username, password, isInternal = false) {
            const endpoint = isInternal ? `${API_BASE}/auth/internal-login` : `${API_BASE}/auth/login`;
            log(`Attempting login for ${username}...`);
            
            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, password })
                });

                if(res.ok) {
                    const data = await res.json();
                    authToken = data.accessToken;
                    
                    // Parse Token
                    const payload = JSON.parse(atob(authToken.split('.')[1]));
                    currentUserInfo = {
                        uid: payload.sub || payload['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier'],
                        username: payload.name || payload['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name'],
                        role: payload['http://schemas.microsoft.com/ws/2008/06/identity/claims/role']
                    };

                    log(`‚úÖ Login Successful! Welcome ${currentUserInfo.username} (${currentUserInfo.role})`);
                    
                    // Update UI
                    document.getElementById('auth-section').style.display = 'none';
                    document.getElementById('dashboard-section').style.display = 'block';
                    document.getElementById('auth-status').textContent = `Logged in as: ${currentUserInfo.username}`;
                    document.getElementById('auth-status').className = 'badge bg-success me-2';
                    document.getElementById('logout-btn').style.display = 'inline-block';

                    // Start Monitor if Admin
                    if (document.getElementById('auto-refresh-toggle').checked) {
                        startMonitor();
                    }
                } else {
                    log(`‚ùå Login Failed: ${res.status}`);
                    const errText = await res.text();
                    log(`Server says: ${errText}`);
                }
            } catch(e) {
                log(`‚ùå Network Error: ${e.message}`);
            }
        }

        // --- Monitor Logic ---
        function toggleMonitor(enabled) {
            if (enabled) startMonitor();
            else stopMonitor();
        }

        function startMonitor() {
            if (monitorInterval) clearInterval(monitorInterval);
            updateServerStatus(); // Run once immediately
            monitorInterval = setInterval(updateServerStatus, 1000); // Every 3 seconds
        }

        function stopMonitor() {
            if (monitorInterval) {
                clearInterval(monitorInterval);
                monitorInterval = null;
            }
        }

        async function updateServerStatus() {
            if (!authToken) return;

            // Admin API calls (parallel)
            try {
                const [userRes, groupRes] = await Promise.all([
                    fetch(`${API_BASE}/admin/retrieve/users`, { headers: { 'Authorization': `Bearer ${authToken}` } }),
                    fetch(`${API_BASE}/admin/retrieve/groups`, { headers: { 'Authorization': `Bearer ${authToken}` } })
                ]);

                // Check auth failure
                if (userRes.status === 401 || groupRes.status === 401) {
                    log("‚ö†Ô∏è Monitor: Unauthorized. Stopping monitor.");
                    stopMonitor();
                    document.getElementById('auto-refresh-toggle').checked = false;
                    return;
                }

                // Update Users Count
                if (userRes.status === 204) {
                    document.getElementById('monitor-user-count').textContent = 0;
                } else if (userRes.ok) {
                    const text = await userRes.text();
                    const users = text ? JSON.parse(text) : [];
                    document.getElementById('monitor-user-count').textContent = users.length;
                }

                // Update Groups Count
                if (groupRes.status === 204) {
                    document.getElementById('monitor-group-count').textContent = 0;
                } else if (groupRes.ok) {
                    const text = await groupRes.text();
                    const groups = text ? JSON.parse(text) : [];
                    document.getElementById('monitor-group-count').textContent = groups.length;
                }

                document.getElementById('monitor-last-update').textContent = new Date().toLocaleTimeString();

            } catch (e) {
                // Ignore network errors during polling to avoid log spam
                console.error("Monitor update failed", e);
            }
        }

        // --- Flush Players Logic ---
        document.getElementById('flush-players-btn').addEventListener('click', async () => {
            if (!authToken) {
                log("‚ùó Flush Players: Not logged in.");
                return;
            }
            if (!confirm('Í≤ΩÍ≥†: Admin/Internal Í≥ÑÏ†ïÏùÑ Ï†úÏô∏Ìïú Î™®Îì† Player ÏÇ¨Ïö©ÏûêÎ•º ÏòÅÍµ¨ ÏÇ≠Ï†úÌï©ÎãàÎã§. Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                log("‚ùó Flush Players: Operation cancelled.");
                return;
            }

            log("üîÑ Deleting all players...");
            try {
                const res = await fetch(`${API_BASE}/admin/users/players`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (res.ok) {
                    const data = await res.json();
                    log(`‚úÖ ${data.message || 'Players deleted.'}`);
                    updateServerStatus(); // Refresh monitor
                } else {
                    const errText = await res.text();
                    log(`‚ùå Flush Players failed: ${res.status} - ${errText}`);
                }
            } catch (e) {
                log(`‚ùå Network error flushing players: ${e.message}`);
            }
        });

        // --- Flush Groups Logic ---
        document.getElementById('flush-groups-btn').addEventListener('click', async () => {
            if (!authToken) {
                log("‚ùó Flush Groups: Not logged in.");
                return;
            }
            if (!confirm('Í≤ΩÍ≥†: Ïù¥ ÏûëÏóÖÏùÄ Î™®Îì† Í∑∏Î£π Îç∞Ïù¥ÌÑ∞Î•º RedisÏóêÏÑú ÏòÅÍµ¨ ÏÇ≠Ï†úÌïòÎ©∞, ÌòÑÏû¨ DBÏóê Ï†ÄÏû•Îêú Î∞±ÏóÖ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. Ï†ïÎßêÎ°ú Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                log("‚ùó Flush Groups: Operation cancelled by user.");
                return;
            }

            log("üîÑ Flushing all group caches...");
            try {
                const res = await fetch(`${API_BASE}/admin/flush/groups`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (res.ok) {
                    log("‚úÖ All group caches successfully flushed!");
                    updateServerStatus(); // Refresh monitor
                } else {
                    const errText = await res.text();
                    log(`‚ùå Flush Groups failed: ${res.status} - ${errText}`);
                }
            } catch (e) {
                log(`‚ùå Network error flushing groups: ${e.message}`);
            }
        });

        // Helper to run batch requests
        async function runBatch(name, count, fn) {
            log(`\nüöÄ STARTING: ${name} (Total: ${count} requests)`);
            log(`‚ÑπÔ∏è  Check console/logs for progress...`);
            
            const startTime = performance.now();
            let success = 0;
            let fail = 0;
            let processed = 0;

            const updateStatus = () => {
                const percent = Math.round((processed / count) * 100);
                document.getElementById('status-footer').textContent = 
                    `${name}: ${percent}% (${success + fail}/${count}) - S:${success} F:${fail}`;
            };

            // Using a simple concurrency limiter
            const batchSize = 10; 
            for (let i = 0; i < count; i += batchSize) {
                const chunk = [];
                for (let j = 0; j < batchSize && (i + j) < count; j++) {
                    chunk.push(fn(i + j));
                }
                
                const results = await Promise.all(chunk);
                results.forEach(r => r ? success++ : fail++);
                processed += results.length;
                
                // Log progress every 20% or at the end
                if (processed % Math.ceil(count / 5) === 0 || processed === count) {
                    const percent = Math.round((processed / count) * 100);
                    log(`... ${name} Progress: ${percent}% (${processed}/${count})`);
                }
                
                updateStatus();
            }

            const endTime = performance.now();
            const duration = ((endTime - startTime) / 1000).toFixed(2);
            log(`\nüèÅ FINISHED: ${name}`);
            log(`‚è±Ô∏è Duration: ${duration}s`);
            log(`‚úÖ Success: ${success}`);
            log(`‚ùå Fail: ${fail}`);
            log(`‚ö° Rate: ${(count / duration).toFixed(1)} req/s`);
        }

        async function runLoginStress() {
            const base = document.getElementById('stress-user-base').value;
            const count = parseInt(document.getElementById('stress-user-count').value);
            const password = 'password1234!'; // Default password
            
            // Ï§ëÎ≥µ Î∞©ÏßÄÎ•º ÏúÑÌïú ÏÑ∏ÏÖò ID (ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Í∏∞Î∞ò)
            const sessionId = Date.now().toString(36);

            log(`\n[Test Info] Login/Register Stress`);
            log(`- Goal: Create & Login ${count} unique users.`);
            log(`- Pattern: Register -> Login (Fallback if reg fails)`);
            log(`- User Prefix: ${base}_${sessionId}_*`);

            await runBatch('Login/Register Stress', count, async (idx) => {
                // Îß§Î≤à Í≥†Ïú†Ìïú ÏïÑÏù¥Îîî ÏÉùÏÑ±
                const username = `${base}_${sessionId}_${idx}`;
                try {
                    // 1. ÌöåÏõêÍ∞ÄÏûÖ ÏãúÎèÑ
                    const regRes = await fetch(`${API_BASE}/auth/register`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ username, password })
                    });
                    
                    // ÌöåÏõêÍ∞ÄÏûÖ Ïã§Ìå® Ïãú(Ïòà: Ïù¥ÎØ∏ Ï°¥Ïû¨) Î°úÍ∑∏ ÎÇ®Í∏∞Í≥† Í≥ÑÏÜç ÏßÑÌñâ
                    if (!regRes.ok) {
                        // 400 Bad Request Îì± ÏóêÎü¨Í∞Ä Î∞úÏÉùÌï¥ÎèÑ Î°úÍ∑∏Ïù∏ÏùÑ ÏãúÎèÑÌï¥Î≥∏Îã§.
                    }
                    
                    // 2. Î°úÍ∑∏Ïù∏ ÏãúÎèÑ
                    const loginRes = await fetch(`${API_BASE}/auth/login`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ username, password })
                    });
                    
                    if(loginRes.ok) {
                        // Î°úÍ∑∏Ïù∏ÏùÄ ÏÑ±Í≥µÌï¥Ïïº ÏµúÏ¢Ö ÏÑ±Í≥µÏúºÎ°ú Í∞ÑÏ£º
                        // log(`[${idx}] Login OK: ${username}`);
                        return true;
                    } else {
                        const err = await loginRes.text();
                        log(`[${idx}] Login Fail: ${loginRes.status} - ${err}`);
                        return false;
                    }
                } catch(e) {
                    log(`[${idx}] Exception: ${e.message}`);
                    return false;
                }
            });
        }

        async function runLobbyStress() {
            const count = parseInt(document.getElementById('stress-lobby-count').value);
            
            log(`\n[Test Info] Lobby Inquiry Stress`);
            log(`- Goal: Simulate ${count} users refreshing the lobby.`);
            log(`- Target: GET /api/group/info/lobby`);
            log(`- Expectation: High RPS, Low Latency (Cached)`);

            await runBatch('Lobby Inquiry', count, async (idx) => {
                try {
                    const res = await fetch(`${API_BASE}/group/info/lobby`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    if(res.ok || res.status === 204) { // 204 is also success (No Content)
                        // log(`[${idx}] Inquiry OK`); // Too spammy
                        return true;
                    } else {
                        log(`[${idx}] Fail: ${res.status}`);
                        return false;
                    }
                } catch(e) {
                    return false;
                }
            });
        }

        async function runGroupStress() {
            const prefix = document.getElementById('stress-group-prefix').value;
            const count = parseInt(document.getElementById('stress-group-count').value);

            await runBatch('Group Creation', count, async (idx) => {
                const groupName = `${prefix}_${idx}_${Math.floor(Math.random()*1000)}`;
                try {
                    const res = await fetch(`${API_BASE}/group/create`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            groupName: groupName,
                            requester: {
                                uid: currentUserInfo.uid,
                                username: currentUserInfo.username
                            }
                        })
                    });

                    if(res.ok) {
                        log(`[${idx}] Created: ${groupName}`);
                        return true;
                    } else {
                        const txt = await res.text();
                        log(`[${idx}] Fail: ${res.status} - ${txt}`);
                        return false;
                    }
                } catch(e) {
                    return false;
                }
            });
        }

        // --- Utils ---
        function log(msg) {
            const el = document.getElementById('logs');
            const line = document.createElement('div');
            line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            el.appendChild(line);
            el.scrollTop = el.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

    </script>
</body>
</html>